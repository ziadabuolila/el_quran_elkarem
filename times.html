<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#007bff" />
    <link rel="icon" href="img/El_Quran_Elkarem_icon.png" />
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="manifest" href="manifest.json" />
    <title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>
  </head>

  <body>
    <header>
      <div class="container">
        <div class="logo">
          <img
            src="img/El_Quran_Elkarem_logo.jpg"
            alt="Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…"
            draggable="false"
          />
          <h1>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
        </div>
        <nav class="nav">
          <ul>
            <li>
              <a href="index.html"> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© </a>
            </li>
            <li>
              <a href="indice.html"> ÙÙ‡Ø±Ø³ Ø§Ù„Ø³ÙˆØ± </a>
            </li>
            <li>
              <a href="music.html"> Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª Ø§Ù„ØµÙˆØªÙŠØ© </a>
            </li>
            <li>
              <a href="sceau_du_coran.html"> Ø®ØªÙ…Ù‡ Ø§Ù„Ù‚Ø±Ø¡Ø§Ù† </a>
            </li>
            <li>
              <a href="supplications_et_souvenirs.html"> Ø§Ø¯Ø¹ÙŠÙ‡ Ùˆ Ø§Ø°ÙƒØ§Ø± </a>
            </li>
            <li>
              <a href="chapelet.html"> Ø§Ù„Ø³Ø¨Ø­Ø© </a>
            </li>
            <li>
              <a href="times.html" class="active"> Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© </a>
            </li>
            <li>
              <a href="supplications.html"> Ø§Ø¨ØªÙ‡Ø§Ù„Ø§Øª</a>
            </li>
            <li>
              <a href="favourite.html"> Ø§Ù„Ù…ÙØ¶Ù„Ø©</a>
            </li>
            <li>
              <a href="calendar.html"> Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</a>
            </li>
            <li>
              <a href="library_section.html"> Ù…Ù‚Ø§Ù„Ø§Øª</a>
            </li>
            <li>
              <a href="wards.html"> Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</a>
            </li>
          </ul>
        </nav>
        <div class="menu-btn">
          <i class="fa fa-bars"></i>
        </div>
      </div>
    </header>
    <div class="overlay" id="overlay"></div>
    <div class="menu" id="menu">
      <div class="menu-header">
        <div class="logo">
          <img
            src="img/El_Quran_Elkarem_logo.jpg"
            alt="Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…"
            draggable="false"
          />
          <p>Ø§Ù„Ù‚Ø±Ø¡Ø§Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</p>
        </div>
        <div class="close-btn" id="closeBtn">
          <i class="fa-solid fa-xmark"></i>
        </div>
      </div>
      <ul>
        <a href="index.html">
          <li>
            <i class="fa-solid fa-house"></i>
            <span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          </li>
        </a>
        <a href="indice.html">
          <li>
            <i class="fa-solid fa-list"></i>
            <span>ÙÙ‡Ø±Ø³ Ø§Ù„Ø³ÙˆØ±</span>
          </li>
        </a>
        <a href="music.html">
          <li>
            <i class="fa-solid fa-headphones"></i>
            <span>Ø§Ù„ØªÙ„Ø§ÙˆØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©</span>
          </li>
        </a>
        <a href="sceau_du_coran.html">
          <li>
            <i class="fa-solid fa-mosque"></i>
            <span>Ø®ØªÙ…Ù‡ Ø§Ù„Ù‚Ø±Ø¢Ù†</span>
          </li>
        </a>
        <a href="supplications_et_souvenirs.html">
          <li>
            <i class="fa-solid fa-hands-praying"></i>
            <span>Ø£Ø¯Ø¹ÙŠØ© ÙˆØ£Ø°ÙƒØ§Ø±</span>
          </li>
        </a>
        <a href="chapelet.html">
          <li>
            <i class="fas fa-circle-dot"></i>
            <span>Ø§Ù„Ø³Ø¨Ø­Ø©</span>
          </li>
        </a>
        <a href="times.html" id="active">
          <li>
            <i class="fas fa-mosque"></i>
            <span>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</span>
          </li>
        </a>
        <a href="supplications.html">
          <li>
            <i class="fas fa-volume-up"></i>
            <span>Ø§Ø¨ØªÙ‡Ø§Ù„Ø§Øª</span>
          </li>
        </a>
        <a href="favourite.html">
          <li>
            <i class="fas fa-heart"></i>
            <span>Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
          </li>
        </a>
        <a href="calendar.html">
          <li>
            <i class="fas fa-calendar"></i>
            <span>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</span>
          </li>
        </a>
        <a href="library_section.html">
          <li>
            <i class="fas fa-file-text"></i>
            <span>Ù…Ù‚Ø§Ù„Ø§Øª</span>
          </li>
        </a>
        <a href="wards.html">
          <li>
            <i class="fas fa-book-open"></i>
            <span>Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
          </li>
        </a>
      </ul>
    </div>
    <div class="container_times">
      <h1 class="container_times_h1">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…</h1>
      <div id="fajr" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„ÙØ¬Ø±</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>

      <div id="sunrise" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„Ø´Ø±ÙˆÙ‚</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>

      <div id="dhuhr" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„Ø¸Ù‡Ø±</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>

      <div id="asr" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„Ø¹ØµØ±</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>

      <div id="maghrib" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„Ù…ØºØ±Ø¨</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>

      <div id="isha" class="prayer-card_times">
        <div class="name_time_azan">
          <span>Ø§Ù„Ø¹Ø´Ø§Ø¡</span>
          <span>--:--</span>
        </div>
        <small class="remaining-time">--</small>
      </div>
    </div>
    <section class="prayer-page">
      <div class="prayer-card">
        <!-- Header -->
        <div class="prayer-header">
          <h1 class="prayer-title">Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙ„Ø§Ø©</h1>
          <p class="prayer-date" id="prayerDate"></p>
        </div>

        <!-- Summary -->
        <div class="prayer-summary">
          <div class="summary-box summary-done">
            <span class="summary-number" id="doneCount">0</span>
            <span class="summary-text">ØµÙ„ÙŠØª</span>
          </div>

          <div class="summary-box summary-missed">
            <span class="summary-number" id="missedCount">0</span>
            <span class="summary-text">ÙØ§ØªÙƒ</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="prayer-progress">
          <div class="prayer-progress-bar" id="progressBar"></div>
        </div>

        <p class="prayer-complete-message" id="completeMessage"></p>

        <!-- Table -->
        <div class="prayer-table-wrapper">
          <table class="prayer-table">
            <thead class="prayer-table-head">
              <tr class="prayer-table-row">
                <th class="prayer-table-th">Ø§Ù„ØµÙ„Ø§Ø©</th>
                <th class="prayer-table-th">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="prayer-table-th">ØªØ³Ø¬ÙŠÙ„</th>
              </tr>
            </thead>
            <tbody class="prayer-table-body" id="prayerTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <audio id="azanAudio" src="audio/azan.mp3"></audio>
    <audio id="shorokAudio" src="audio/shorok.mp3"></audio>
    <script>
      const CITY = "Cairo";
      const COUNTRY = "Egypt";
      const STORAGE_KEY = "notificationsAllowed";

      // ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø§Ù…
      const azanAudio = new Audio("audio/azan.mp3");

      // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      function requestNotificationPermission() {
        if (!("Notification" in window)) return;
        const alreadyAllowed = localStorage.getItem(STORAGE_KEY);
        if (
          Notification.permission === "granted" ||
          alreadyAllowed === "true"
        ) {
          localStorage.setItem(STORAGE_KEY, "true");
          return;
        }
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            localStorage.setItem(STORAGE_KEY, "true");
          }
        });
      }

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† 24 Ø³Ø§Ø¹Ø© Ù„Ù€ 12 Ø³Ø§Ø¹Ø©
      function formatTo12Hour(time24) {
        let [hour, minute] = time24.split(":");
        hour = parseInt(hour, 10);
        const ampm = hour >= 12 ? "PM" : "AM";
        hour = hour % 12 || 12;
        return `${hour}:${minute} ${ampm}`;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„ÙƒÙ„ ØµÙ„Ø§Ø©
      function startRemainingCountdown(times) {
        function update() {
          const now = new Date();
          Object.keys(times).forEach((key) => {
            const card = document.getElementById(key.toLowerCase());
            if (!card) return;
            const remainingEl = card.querySelector(".remaining-time");
            if (!remainingEl) return;
            const [h, m] = times[key].split(":");
            const target = new Date();
            target.setHours(+h, +m, 0, 0);
            let diff = target - now;
            if (diff <= 0) {
              remainingEl.innerText =
                "0 Ø³Ø§Ø¹Ø© 0 Ø¯Ù‚ÙŠÙ‚Ø© 0 Ø«Ø§Ù†ÙŠØ© â€” ØªÙ… Ø¥Ù‚Ø§Ù…Ø© Ø§Ù„ØµÙ„Ø§Ø©";
              return;
            }
            const hours = Math.floor(diff / 3600000);
            diff %= 3600000;
            const minutes = Math.floor(diff / 60000);
            diff %= 60000;
            const seconds = Math.floor(diff / 1000);
            remainingEl.innerText = `Ù…ØªØ¨Ù‚ÙŠ: ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ©`;
          });
        }
        update();
        setInterval(update, 1000);
      }

      // Ø¬Ù„Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ù† API
      async function fetchPrayerTimes(city, country) {
        const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=5`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          const times = data.data.timings;

          // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ù€ 12 Ø³Ø§Ø¹Ø©
          ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"].forEach(
            (prayer) => {
              const cardSpan = document.querySelector(
                `#${prayer.toLowerCase()} .name_time_azan span:last-child`
              );
              if (cardSpan) cardSpan.innerText = formatTo12Hour(times[prayer]);
            }
          );

          // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
          startRemainingCountdown(times);

          // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
          scheduleAzan(times);
        } catch (error) {
          console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©:", error);
        }
      }

      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
      function scheduleAzan(times) {
        const now = new Date();
        const prayerTimes = {
          Fajr: times.Fajr,
          Sunrise: times.Sunrise,
          Dhuhr: times.Dhuhr,
          Asr: times.Asr,
          Maghrib: times.Maghrib,
          Isha: times.Isha,
        };

        Object.keys(prayerTimes).forEach((prayer) => {
          const [hour, minute] = prayerTimes[prayer].split(":");
          const prayerDate = new Date();
          prayerDate.setHours(+hour, +minute, 0, 0);
          let delay = prayerDate - now;
          if (delay < 0) return;

          setTimeout(() => {
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†
            azanAudio.currentTime = 0;
            azanAudio.play().catch(() => {});

            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
            if (
              Notification.permission === "granted" ||
              localStorage.getItem(STORAGE_KEY) === "true"
            ) {
              new Notification(`ğŸ•Œ ÙˆÙ‚Øª ${prayer}`, {
                body: `Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© ${prayer}`,
                icon: "https://github.com/ziadabuolila/el_quran_elkarem/blob/main/img/El_Quran_Elkarem_icon.png?raw=true",
              });
            }
          }, delay);
        });
      }

      // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„
      requestNotificationPermission();
      fetchPrayerTimes(CITY, COUNTRY);
      setInterval(() => fetchPrayerTimes(CITY, COUNTRY), 1000 * 60 * 60);
    </script>

    <script>
      const prayerList = ["Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¸Ù‡Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù…ØºØ±Ø¨", "Ø§Ù„Ø¹Ø´Ø§Ø¡"];
      const todayKey = new Date().toLocaleDateString("ar-EG");

      const prayerDate = document.getElementById("prayerDate");
      const prayerTableBody = document.getElementById("prayerTableBody");
      const doneCount = document.getElementById("doneCount");
      const missedCount = document.getElementById("missedCount");
      const progressBar = document.getElementById("progressBar");
      const completeMessage = document.getElementById("completeMessage");

      function renderDate() {
        prayerDate.textContent = new Date().toLocaleDateString("ar-EG", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function loadPrayerTable() {
        const data = JSON.parse(localStorage.getItem("prayerTracker")) || {};
        const todayData = data[todayKey] || {};

        prayerTableBody.innerHTML = "";

        let done = 0;
        let missed = 0;

        prayerList.forEach((prayer) => {
          const status = todayData[prayer];

          if (status === "yes") done++;
          if (status === "no") missed++;

          const row = document.createElement("tr");
          row.className = "prayer-table-row";

          row.innerHTML = `
      <td class="prayer-table-td">${prayer}</td>
      <td class="prayer-table-td ${
        status === "yes"
          ? "prayer-status--done"
          : status === "no"
          ? "prayer-status--missed"
          : ""
      }">
        ${status === "yes" ? "âœ”ï¸ ØµÙ„ÙŠØª" : status === "no" ? "âŒ Ù„Ù… Ø£ØµÙ„Ù‘Ù" : "â€”"}
      </td>
      <td class="prayer-table-td">
        <div class="prayer-actions">
          <button class="prayer-btn prayer-btn--yes" onclick="savePrayer('${prayer}','yes')">ØµÙ„ÙŠØª</button>
          <button class="prayer-btn prayer-btn--no" onclick="savePrayer('${prayer}','no')">Ù„Ù… Ø£ØµÙ„Ù‘Ù</button>
        </div>
      </td>
    `;

          prayerTableBody.appendChild(row);
        });

        doneCount.textContent = done;
        missedCount.textContent = missed;
        progressBar.style.width = (done / prayerList.length) * 100 + "%";

        completeMessage.textContent =
          done === prayerList.length ? "ğŸŒŸ ÙŠÙˆÙ… ØµÙ„Ø§Ø© ÙƒØ§Ù…Ù„ â€“ Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ" : "";
      }

      function savePrayer(prayer, value) {
        const data = JSON.parse(localStorage.getItem("prayerTracker")) || {};
        if (!data[todayKey]) data[todayKey] = {};
        data[todayKey][prayer] = value;

        localStorage.setItem("prayerTracker", JSON.stringify(data));
        loadPrayerTable();
      }

      renderDate();
      loadPrayerTable();  
    </script>
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/all.min.js"></script>
    <script src="js/main.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("js/sw.js")
          .then((reg) => console.log("Service Worker registered:", reg))
          .catch((err) =>
            console.log("Service Worker registration failed:", err)
          );
      }
    </script>
  </body>
</html>
